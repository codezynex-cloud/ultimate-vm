#!/bin/bash
# ============================================================================
# CAVRIX CORE HYPERVISOR v12.0
# Ultimate Virtualization Platform
# Powered By root@cavrix.core
# ============================================================================

set -eo pipefail
trap 'echo -e "\033[0;31mError at line $LINENO\033[0m"' ERR

# ============================================================================
# CAVRIX CORE CONFIGURATION
# ============================================================================
readonly CAVRIX_VERSION="12.0.0"
readonly CAVRIX_DIR="${CAVRIX_DIR:-$HOME/cavrix-core}"
readonly VM_DIR="$CAVRIX_DIR/vms"
readonly ISO_DIR="$CAVRIX_DIR/isos"
readonly DISK_DIR="$CAVRIX_DIR/disks"
readonly SCRIPT_DIR="$CAVRIX_DIR/scripts"
readonly CONFIG_DIR="$CAVRIX_DIR/configs"
readonly LOG_DIR="$CAVRIX_DIR/logs"
readonly BACKUP_DIR="$CAVRIX_DIR/backups"
readonly SNAPSHOT_DIR="$CAVRIX_DIR/snapshots"
readonly RDP_DIR="$CAVRIX_DIR/rdp"

# Create directories with minimal space usage
mkdir -p "$CAVRIX_DIR" "$VM_DIR" "$ISO_DIR" "$DISK_DIR" "$SCRIPT_DIR" \
         "$CONFIG_DIR" "$LOG_DIR" "$BACKUP_DIR" "$SNAPSHOT_DIR"

# ============================================================================
# CAVRIX CORE THEME - ADVANCED
# ============================================================================
readonly CC_BLACK="\033[0;30m"
readonly CC_RED="\033[0;31m"
readonly CC_GREEN="\033[0;32m"
readonly CC_YELLOW="\033[1;33m"
readonly CC_BLUE="\033[0;34m"
readonly CC_MAGENTA="\033[0;35m"
readonly CC_CYAN="\033[0;36m"
readonly CC_WHITE="\033[1;37m"
readonly CC_ORANGE="\033[38;5;208m"
readonly CC_PURPLE="\033[38;5;93m"
readonly CC_NEON="\033[38;5;46m"
readonly CC_GOLD="\033[38;5;220m"
readonly CC_RESET="\033[0m"

# Icons
readonly IC_CPU="âš¡"
readonly IC_RAM="ğŸ§ "
readonly IC_DISK="ğŸ’¾"
readonly IC_NET="ğŸŒ"
readonly IC_SEC="ğŸ”"
readonly IC_AI="ğŸ¤–"
readonly IC_OK="âœ…"
readonly IC_ERR="âŒ"
readonly IC_WARN="âš ï¸"
readonly IC_INFO="â„¹ï¸"
readonly IC_ROCKET="ğŸš€"
readonly IC_STAR="â­"
readonly IC_FIRE="ğŸ”¥"
readonly IC_CLOUD="â˜ï¸"
readonly IC_SHIELD="ğŸ›¡ï¸"
readonly IC_TROPHY="ğŸ†"
readonly IC_RDP="ğŸ–¥ï¸"
readonly IC_TIME="â±ï¸"

# ============================================================================
# CAVRIX CORE BANNER
# ============================================================================
cavrix_banner() {
    clear
    echo -e "${CC_NEON}"
    cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                      â•‘
â•‘     ___                 _          ___                               â•‘
â•‘    / __\__ ___   ___ __(_)_  __   / __\___  _ __ ___                 â•‘
â•‘   / /  / _` \ \ / / '__| \ \/ /  / /  / _ \| '__/ _ \                â•‘
â•‘  / /__| (_| |\ V /| |  | |>  <  / /__| (_) | | |  __/                â•‘
â•‘  \____/\__,_| \_/ |_|  |_/_/\_\ \____/\___/|_|  \___|                â•‘
â•‘                                                                      â•‘
â•‘                    CAVRIX CORE HYPERVISOR                           â•‘
â•‘                         Version ${CAVRIX_VERSION}                              â•‘
â•‘                    Powered By root@cavrix.core                      â•‘
â•‘                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${CC_RESET}"
}

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================
cavrix_log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" >> "$LOG_DIR/cavrix.log"
}

cavrix_print() {
    local type="$1"
    shift
    local message="$*"
    
    case "$type" in
        "success")
            echo -e "${CC_GREEN}${IC_OK} $message${CC_RESET}"
            cavrix_log "SUCCESS" "$message"
            ;;
        "error")
            echo -e "${CC_RED}${IC_ERR} $message${CC_RESET}"
            cavrix_log "ERROR" "$message"
            ;;
        "warning")
            echo -e "${CC_YELLOW}${IC_WARN} $message${CC_RESET}"
            cavrix_log "WARNING" "$message"
            ;;
        "info")
            echo -e "${CC_CYAN}${IC_INFO} $message${CC_RESET}"
            cavrix_log "INFO" "$message"
            ;;
        "header")
            echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
            echo -e "${CC_PURPLE}  $message${CC_RESET}"
            echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
            ;;
        "ai")
            echo -e "${CC_MAGENTA}${IC_AI} $message${CC_RESET}"
            cavrix_log "AI" "$message"
            ;;
        "rdp")
            echo -e "${CC_BLUE}${IC_RDP} $message${CC_RESET}"
            cavrix_log "RDP" "$message"
            ;;
        "cavrix")
            echo -e "${CC_NEON}[CAVRIX CORE] $message${CC_RESET}"
            cavrix_log "CAVRIX" "$message"
            ;;
    esac
}

# ============================================================================
# DEPENDENCY CHECK
# ============================================================================
check_dependencies() {
    cavrix_print "cavrix" "Checking system dependencies..."
    
    local deps=("qemu-system-x86_64" "qemu-img" "wget")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &>/dev/null; then
            missing+=("$dep")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        cavrix_print "error" "Missing dependencies: ${missing[*]}"
        
        if command -v apt &>/dev/null; then
            cavrix_print "info" "Installing dependencies..."
            sudo apt update
            sudo apt install -y qemu-system qemu-utils wget curl
        elif command -v yum &>/dev/null; then
            sudo yum install -y qemu-kvm qemu-img wget curl
        fi
    fi
    
    # Check available space
    local available_kb=$(df "$CAVRIX_DIR" 2>/dev/null | awk 'NR==2 {print $4}' || echo "0")
    if [[ "$available_kb" -lt 100000 ]]; then
        cavrix_print "warning" "Low disk space: $((available_kb / 1024))MB available"
    fi
    
    cavrix_print "success" "Dependencies verified"
}

# ============================================================================
# COMPACT OS DATABASE (Optimized for Small Space)
# ============================================================================
declare -A CAVRIX_OS_DB=(
    ["alpine"]="Alpine Linux|linux|https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-virt-3.19.0-x86_64.iso|root|alpine|128M"
    ["tinycore"]="Tiny Core Linux|linux|http://tinycorelinux.net/13.x/x86_64/release/TinyCorePure64-13.0.iso|tc|tc|64M"
    ["puppy"]="Puppy Linux|linux|http://distro.ibiblio.org/puppylinux/puppy-fossa/fossapup64-9.5.iso|root|linux|300M"
    ["ubuntu-mini"]="Ubuntu Minimal|linux|https://cloud-images.ubuntu.com/minimal/releases/jammy/release/ubuntu-22.04-minimal-cloudimg-amd64.img|ubuntu|ubuntu|500M"
    ["debian-net"]="Debian Netinstall|linux|https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-12.5.0-amd64-netinst.iso|debian|debian|350M"
    ["kali-light"]="Kali Light|linux|https://cdimage.kali.org/kali-2024.2/kali-linux-2024.2-light-amd64.iso|kali|kali|800M"
)

# ============================================================================
# CREATE VM WIZARD
# ============================================================================
create_vm() {
    cavrix_banner
    cavrix_print "header" "CREATE VIRTUAL MACHINE"
    
    # VM Name
    while true; do
        read -rp "$(echo -e "${CC_NEON}${IC_STAR} VM Name: ${CC_RESET}")" vm_name
        
        if [[ -z "$vm_name" ]]; then
            cavrix_print "error" "Name cannot be empty"
            continue
        fi
        
        if [[ ! "$vm_name" =~ ^[a-z][a-z0-9-]{2,20}$ ]]; then
            cavrix_print "error" "Use lowercase, numbers, hyphens (3-20 chars)"
            continue
        fi
        
        if [[ -f "$SCRIPT_DIR/start-$vm_name.sh" ]]; then
            cavrix_print "error" "VM already exists"
            continue
        fi
        
        break
    done
    
    # OS Selection
    cavrix_print "info" "${IC_CLOUD} Select Operating System:"
    echo ""
    
    local i=1
    declare -A os_options
    for os_key in "${!CAVRIX_OS_DB[@]}"; do
        IFS='|' read -r os_name os_type os_url os_user os_pass os_size <<< "${CAVRIX_OS_DB[$os_key]}"
        os_options[$i]="$os_key"
        printf "${CC_GREEN}%2d)${CC_RESET} %-20s ${CC_GRAY}[%s]${CC_RESET}\n" "$i" "$os_name" "$os_size"
        ((i++))
    done
    
    echo ""
    read -rp "$(echo -e "${CC_NEON}Select OS (1-$((i-1))): ${CC_RESET}")" os_choice
    
    local os_key="${os_options[$os_choice]}"
    if [[ -z "$os_key" ]]; then
        cavrix_print "error" "Invalid selection"
        return 1
    fi
    
    IFS='|' read -r os_name os_type os_url os_user os_pass os_size <<< "${CAVRIX_OS_DB[$os_key]}"
    
    # Configuration
    cavrix_print "header" "HARDWARE CONFIGURATION"
    
    # CPU
    read -rp "$(echo -e "${CC_CYAN}${IC_CPU} CPU cores (1-4): ${CC_RESET}")" cpu_cores
    cpu_cores=${cpu_cores:-1}
    
    # Memory
    read -rp "$(echo -e "${CC_CYAN}${IC_RAM} RAM in MB (256-2048): ${CC_RESET}")" memory_mb
    memory_mb=${memory_mb:-512}
    
    # Disk
    read -rp "$(echo -e "${CC_CYAN}${IC_DISK} Disk size (1G-20G): ${CC_RESET}")" disk_size
    disk_size=${disk_size:-5G}
    
    # Network
    cavrix_print "info" "${IC_NET} Network Type:"
    echo "1) NAT with SSH port forward"
    echo "2) User network"
    echo "3) No network"
    
    read -rp "$(echo -e "${CC_CYAN}Select (1-3): ${CC_RESET}")" net_type
    net_type=${net_type:-1}
    
    # Download OS
    cavrix_print "info" "${IC_CLOUD} Downloading $os_name..."
    
    local iso_file="$ISO_DIR/$(basename "$os_url")"
    local disk_file="$DISK_DIR/$vm_name.qcow2"
    
    # Check space before download
    local free_space=$(df "$ISO_DIR" | awk 'NR==2 {print $4}')
    if [[ "$free_space" -lt 100000 ]]; then
        cavrix_print "warning" "Low disk space, using cached if available"
    fi
    
    if [[ ! -f "$iso_file" ]]; then
        if wget -q --show-progress -O "$iso_file.tmp" "$os_url"; then
            mv "$iso_file.tmp" "$iso_file"
            cavrix_print "success" "Download complete"
        else
            cavrix_print "error" "Download failed"
            return 1
        fi
    else
        cavrix_print "info" "Using cached image"
    fi
    
    # Create disk
    cavrix_print "info" "${IC_DISK} Creating virtual disk..."
    
    if [[ "$os_url" == *.qcow2 ]] || [[ "$os_url" == *.img ]]; then
        cp "$iso_file" "$disk_file"
        qemu-img resize "$disk_file" "$disk_size" 2>/dev/null || true
    else
        qemu-img create -f qcow2 "$disk_file" "$disk_size"
    fi
    
    # Generate startup script
    generate_vm_script "$vm_name" "$cpu_cores" "$memory_mb" "$net_type" "$os_user"
    
    # Save config
    save_vm_config "$vm_name" "$os_name" "$cpu_cores" "$memory_mb" "$disk_size"
    
    cavrix_print "success" "${IC_TROPHY} VM '$vm_name' CREATED!"
    echo ""
    echo -e "${CC_CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    echo -e "${CC_GREEN}Start VM:${CC_RESET}     ./start-$vm_name.sh"
    echo -e "${CC_GREEN}Stop VM:${CC_RESET}      ./stop-$vm_name.sh"
    echo -e "${CC_GREEN}SSH Access:${CC_RESET}   ssh $os_user@localhost -p 2222"
    echo -e "${CC_GREEN}Directory:${CC_RESET}    $DISK_DIR/"
    echo -e "${CC_NEON}Powered By root@cavrix.core${CC_RESET}"
}

# ============================================================================
# GENERATE VM SCRIPT
# ============================================================================
generate_vm_script() {
    local vm_name="$1"
    local cpu_cores="$2"
    local memory_mb="$3"
    local net_type="$4"
    local os_user="$5"
    
    local script_file="$SCRIPT_DIR/start-$vm_name.sh"
    local disk_file="$DISK_DIR/$vm_name.qcow2"
    
    cat > "$script_file" << EOF
#!/bin/bash
# Cavrix Core VM: $vm_name
# Powered By root@cavrix.core

VM_NAME="$vm_name"
DISK_FILE="$disk_file"
CPU_CORES=$cpu_cores
MEMORY_MB=$memory_mb

echo -e "\033[38;5;46m[CAVRIX CORE] Starting VM: \$VM_NAME\033[0m"

# Check if already running
if pgrep -f "qemu-system.*\$VM_NAME" > /dev/null; then
    echo -e "\033[33mâš ï¸  VM is already running\033[0m"
    exit 0
fi

# Build QEMU command
QEMU_CMD="qemu-system-x86_64"

# KVM acceleration
if [[ -e /dev/kvm ]]; then
    QEMU_CMD+=" -enable-kvm -cpu host"
else
    QEMU_CMD+=" -cpu qemu64"
fi

# Basic parameters
QEMU_CMD+=" -name \$VM_NAME"
QEMU_CMD+=" -smp \$CPU_CORES"
QEMU_CMD+=" -m \$MEMORY_MB"

# Disk
QEMU_CMD+=" -drive file=\$DISK_FILE,if=virtio,cache=writeback"

# Network
case "$net_type" in
    1)
        QEMU_CMD+=" -netdev user,id=net0,hostfwd=tcp::2222-:22"
        QEMU_CMD+=" -device virtio-net-pci,netdev=net0"
        ;;
    2)
        QEMU_CMD+=" -netdev user,id=net0"
        QEMU_CMD+=" -device virtio-net-pci,netdev=net0"
        ;;
    *)
        # No network
        ;;
esac

# Display (minimal)
QEMU_CMD+=" -nographic"
QEMU_CMD+=" -serial mon:stdio"

# Boot order
QEMU_CMD+=" -boot order=c"

# Daemonize
QEMU_CMD+=" -daemonize"

echo -e "\033[36mStarting VM...\033[0m"
eval "\$QEMU_CMD"

if [[ \$? -eq 0 ]]; then
    echo -e "\033[32mâœ… VM started successfully!\033[0m"
    
    if [[ "$net_type" == "1" ]]; then
        echo -e "\033[36mSSH Access:\033[0m ssh $os_user@localhost -p 2222"
    fi
    
    echo -e "\033[38;5;46m[CAVRIX CORE] VM Status: RUNNING\033[0m"
else
    echo -e "\033[31mâŒ Failed to start VM\033[0m"
    exit 1
fi
EOF
    
    # Create stop script
    cat > "$SCRIPT_DIR/stop-$vm_name.sh" << EOF
#!/bin/bash
# Stop Cavrix Core VM: $vm_name

VM_NAME="$vm_name"
PID=\$(pgrep -f "qemu-system.*\$VM_NAME")

if [[ -n "\$PID" ]]; then
    kill \$PID
    echo -e "\033[32mâœ… VM stopped\033[0m"
    echo -e "\033[38;5;46m[CAVRIX CORE] VM Status: STOPPED\033[0m"
else
    echo -e "\033[33mâš ï¸  VM is not running\033[0m"
fi
EOF
    
    # Create simple launchers
    cat > "./start-$vm_name.sh" << EOF
#!/bin/bash
bash "$script_file"
EOF
    
    cat > "./stop-$vm_name.sh" << EOF
#!/bin/bash
bash "$SCRIPT_DIR/stop-$vm_name.sh"
EOF
    
    chmod +x "$script_file" "$SCRIPT_DIR/stop-$vm_name.sh" "./start-$vm_name.sh" "./stop-$vm_name.sh"
    
    cavrix_print "success" "Scripts generated: start-$vm_name.sh, stop-$vm_name.sh"
}

# ============================================================================
# SAVE VM CONFIG
# ============================================================================
save_vm_config() {
    local vm_name="$1"
    local os_name="$2"
    local cpu_cores="$3"
    local memory_mb="$4"
    local disk_size="$5"
    
    local config_file="$CONFIG_DIR/$vm_name.conf"
    
    cat > "$config_file" << EOF
# Cavrix Core VM Configuration
# Generated: $(date)
# Powered By root@cavrix.core

[metadata]
name = $vm_name
os = $os_name
created = $(date '+%Y-%m-%d %H:%M:%S')
version = $CAVRIX_VERSION

[hardware]
cpu_cores = $cpu_cores
memory_mb = $memory_mb
disk_size = $disk_size

[files]
disk = $DISK_DIR/$vm_name.qcow2
script = $SCRIPT_DIR/start-$vm_name.sh

[status]
state = created
EOF
    
    cavrix_print "info" "Configuration saved"
}

# ============================================================================
# RDP SETUP (SEPARATE OPTION)
# ============================================================================
setup_rdp() {
    cavrix_banner
    cavrix_print "header" "RDP SERVER SETUP"
    
    cavrix_print "rdp" "Setting up Remote Desktop Server..."
    
    echo -e "${CC_YELLOW}This will install:${CC_RESET}"
    echo "  â€¢ XRDP (Remote Desktop Protocol)"
    echo "  â€¢ XFCE4 (Lightweight Desktop)"
    echo "  â€¢ Required dependencies"
    echo ""
    
    read -rp "$(echo -e "${CC_NEON}Continue? (Y/n): ${CC_RESET}")" confirm
    
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        return
    fi
    
    # Update system
    cavrix_print "info" "Updating system..."
    sudo apt update
    sudo apt upgrade -y
    
    # Install XRDP and XFCE
    cavrix_print "info" "Installing XRDP and XFCE..."
    sudo apt install -y xfce4 xfce4-goodies xrdp
    
    # Configure XRDP
    cavrix_print "info" "Configuring XRDP..."
    echo "startxfce4" > ~/.xsession
    sudo chown $(whoami):$(whoami) ~/.xsession
    
    # Configure XRDP to use port 3390 (to avoid conflicts)
    sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
    
    # Start services
    cavrix_print "info" "Starting services..."
    sudo systemctl enable xrdp
    sudo systemctl restart xrdp
    
    # Get connection info
    local ip_addr=$(hostname -I | awk '{print $1}')
    if [[ -z "$ip_addr" ]]; then
        ip_addr="localhost"
    fi
    
    cavrix_print "success" "${IC_RDP} RDP SERVER READY!"
    echo ""
    echo -e "${CC_CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    echo -e "${CC_GREEN}Connection Details:${CC_RESET}"
    echo -e "  ${CC_YELLOW}IP Address:${CC_RESET}   $ip_addr"
    echo -e "  ${CC_YELLOW}Port:${CC_RESET}         3390"
    echo -e "  ${CC_YELLOW}Protocol:${CC_RESET}     RDP over TCP"
    echo -e "  ${CC_YELLOW}Username:${CC_RESET}     $(whoami)"
    echo -e "  ${CC_YELLOW}Password:${CC_RESET}     Your system password"
    echo ""
    echo -e "${CC_CYAN}How to Connect:${CC_RESET}"
    echo "1. Windows: Remote Desktop Connection"
    echo "2. Linux: xfreerdp /v:$ip_addr:3390"
    echo "3. Android: Microsoft Remote Desktop app"
    echo ""
    echo -e "${CC_NEON}Powered By root@cavrix.core${CC_RESET}"
    echo ""
    
    # Test RDP port
    if nc -z localhost 3390; then
        cavrix_print "success" "RDP service is running"
    else
        cavrix_print "warning" "RDP service check failed"
    fi
}

# ============================================================================
# LIST VIRTUAL MACHINES
# ============================================================================
list_vms() {
    cavrix_banner
    cavrix_print "header" "VIRTUAL MACHINES"
    
    local vms=($(ls "$SCRIPT_DIR"/start-*.sh 2>/dev/null | xargs -n1 basename | sed 's/start-//;s/.sh//'))
    
    if [[ ${#vms[@]} -eq 0 ]]; then
        cavrix_print "warning" "No virtual machines found"
        echo -e "${CC_NEON}Create your first VM with option 1${CC_RESET}"
        return
    fi
    
    echo -e "${CC_CYAN}Available VMs:${CC_RESET}"
    echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    
    for vm in "${vms[@]}"; do
        local status="${CC_RED}STOPPED${CC_RESET}"
        local pid=$(pgrep -f "qemu-system.*$vm")
        
        if [[ -n "$pid" ]]; then
            status="${CC_GREEN}RUNNING${CC_RESET}"
        fi
        
        local config_file="$CONFIG_DIR/$vm.conf"
        local os_name="Unknown"
        local cpu="?"
        local mem="?"
        
        if [[ -f "$config_file" ]]; then
            os_name=$(grep "^os = " "$config_file" | cut -d'=' -f2 | xargs)
            cpu=$(grep "^cpu_cores = " "$config_file" | cut -d'=' -f2 | xargs)
            mem=$(grep "^memory_mb = " "$config_file" | cut -d'=' -f2 | xargs)
        fi
        
        echo -e "  ${CC_GOLD}â–¸${CC_RESET} ${CC_WHITE}$vm${CC_RESET}"
        echo -e "     ${CC_CYAN}OS:${CC_RESET} $os_name"
        echo -e "     ${CC_CYAN}CPU:${CC_RESET} ${cpu}c | ${CC_CYAN}RAM:${CC_RESET} ${mem}MB"
        echo -e "     ${CC_CYAN}Status:${CC_RESET} $status"
        echo ""
    done
    
    echo -e "${CC_NEON}Total VMs: ${#vms[@]}${CC_RESET}"
    echo -e "${CC_NEON}Powered By root@cavrix.core${CC_RESET}"
}

# ============================================================================
# START VM
# ============================================================================
start_vm() {
    list_vms
    echo ""
    
    read -rp "$(echo -e "${CC_NEON}Enter VM name to start: ${CC_RESET}")" vm_name
    
    if [[ -f "$SCRIPT_DIR/start-$vm_name.sh" ]]; then
        cavrix_print "info" "Starting VM: $vm_name"
        bash "$SCRIPT_DIR/start-$vm_name.sh"
    elif [[ -f "./start-$vm_name.sh" ]]; then
        cavrix_print "info" "Starting VM: $vm_name"
        bash "./start-$vm_name.sh"
    else
        cavrix_print "error" "VM not found"
    fi
}

# ============================================================================
# STOP VM
# ============================================================================
stop_vm() {
    cavrix_print "header" "STOP VIRTUAL MACHINE"
    
    echo -e "${CC_YELLOW}Running VMs:${CC_RESET}"
    ps aux | grep "[q]emu-system" | awk '{printf "  [%s] %s\n", $2, $13}'
    
    echo ""
    read -rp "$(echo -e "${CC_NEON}Enter PID to stop: ${CC_RESET}")" pid
    
    if [[ -n "$pid" ]]; then
        if kill "$pid"; then
            cavrix_print "success" "VM stopped"
        else
            cavrix_print "error" "Failed to stop VM"
        fi
    else
        cavrix_print "info" "No PID entered"
    fi
}

# ============================================================================
# DELETE VM
# ============================================================================
delete_vm() {
    list_vms
    echo ""
    
    read -rp "$(echo -e "${CC_NEON}Enter VM name to delete: ${CC_RESET}")" vm_name
    
    # Confirm
    read -rp "$(echo -e "${CC_RED}Type 'DELETE' to confirm: ${CC_RESET}")" confirm
    
    if [[ "$confirm" != "DELETE" ]]; then
        cavrix_print "info" "Deletion cancelled"
        return
    fi
    
    # Stop VM if running
    local pid=$(pgrep -f "qemu-system.*$vm_name")
    if [[ -n "$pid" ]]; then
        kill "$pid"
        cavrix_print "info" "VM stopped"
    fi
    
    # Remove files
    rm -f "$DISK_DIR/$vm_name.qcow2"
    rm -f "$SCRIPT_DIR/start-$vm_name.sh"
    rm -f "$SCRIPT_DIR/stop-$vm_name.sh"
    rm -f "./start-$vm_name.sh"
    rm -f "./stop-$vm_name.sh"
    rm -f "$CONFIG_DIR/$vm_name.conf"
    
    cavrix_print "success" "VM '$vm_name' deleted"
    echo -e "${CC_NEON}Powered By root@cavrix.core${CC_RESET}"
}

# ============================================================================
# SYSTEM STATUS
# ============================================================================
system_status() {
    cavrix_banner
    cavrix_print "header" "SYSTEM STATUS"
    
    # System Info
    echo -e "${CC_CYAN}System Information:${CC_RESET}"
    echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    
    echo -e "${CC_GREEN}Hostname:${CC_RESET} $(hostname)"
    echo -e "${CC_GREEN}OS:${CC_RESET} $(lsb_release -ds 2>/dev/null || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
    echo -e "${CC_GREEN}Kernel:${CC_RESET} $(uname -r)"
    echo -e "${CC_GREEN}Uptime:${CC_RESET} $(uptime -p | sed 's/up //')"
    
    # Resources
    echo ""
    echo -e "${CC_CYAN}Resource Usage:${CC_RESET}"
    echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    
    # CPU
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    echo -e "${IC_CPU} CPU Usage: ${CC_GREEN}$cpu_usage%${CC_RESET}"
    
    # Memory
    local mem_total=$(free -m | awk '/Mem:/ {print $2}')
    local mem_used=$(free -m | awk '/Mem:/ {print $3}')
    local mem_percent=$((mem_used * 100 / mem_total))
    echo -e "${IC_RAM} Memory: ${CC_GREEN}$mem_used MB / $mem_total MB ($mem_percent%)${CC_RESET}"
    
    # Disk
    local disk_usage=$(df -h "$CAVRIX_DIR" | awk 'NR==2 {print $5}')
    echo -e "${IC_DISK} Disk Usage: ${CC_GREEN}$disk_usage${CC_RESET}"
    
    # VM Stats
    echo ""
    echo -e "${CC_CYAN}Cavrix Core Statistics:${CC_RESET}"
    echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    
    local total_vms=$(ls "$SCRIPT_DIR"/start-*.sh 2>/dev/null | wc -l)
    local running_vms=$(ps aux | grep -c "[q]emu-system")
    local disk_size=$(du -sh "$CAVRIX_DIR" 2>/dev/null | cut -f1)
    
    echo -e "${IC_CLOUD} Total VMs: ${CC_GREEN}$total_vms${CC_RESET}"
    echo -e "${IC_ROCKET} Running VMs: ${CC_GREEN}$running_vms${CC_RESET}"
    echo -e "${IC_DISK} Storage Used: ${CC_GREEN}$disk_size${CC_RESET}"
    echo -e "${IC_TIME} Logs: ${CC_GREEN}$(tail -1 "$LOG_DIR/cavrix.log" 2>/dev/null | cut -d' ' -f1-3 || echo "No logs")${CC_RESET}"
    
    echo ""
    echo -e "${CC_NEON}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
    echo -e "${CC_NEON}                    Powered By root@cavrix.core                       ${CC_RESET}"
    echo -e "${CC_NEON}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
}

# ============================================================================
# CLEANUP SYSTEM
# ============================================================================
cleanup_system() {
    cavrix_banner
    cavrix_print "header" "SYSTEM CLEANUP"
    
    echo -e "${CC_YELLOW}âš ï¸  Cleanup Options:${CC_RESET}"
    echo ""
    echo "1) Clear ISO cache"
    echo "2) Remove old logs"
    echo "3) Compact disk images"
    echo "4) Check disk space"
    echo "0) Back"
    
    read -rp "$(echo -e "${CC_NEON}Select option: ${CC_RESET}")" choice
    
    case $choice in
        1)
            local cache_size=$(du -sh "$ISO_DIR" 2>/dev/null | cut -f1)
            rm -rf "$ISO_DIR"/*
            mkdir -p "$ISO_DIR"
            cavrix_print "success" "Cleared ISO cache ($cache_size freed)"
            ;;
        2)
            rm -f "$LOG_DIR"/*.log.old 2>/dev/null
            find "$LOG_DIR" -name "*.log" -mtime +7 -delete 2>/dev/null
            cavrix_print "success" "Old logs removed"
            ;;
        3)
            for disk in "$DISK_DIR"/*.qcow2 2>/dev/null; do
                if [[ -f "$disk" ]]; then
                    qemu-img convert -O qcow2 "$disk" "${disk}.tmp" && mv "${disk}.tmp" "$disk"
                    echo "Compacted: $(basename "$disk")"
                fi
            done
            cavrix_print "success" "Disk images compacted"
            ;;
        4)
            df -h "$CAVRIX_DIR"
            ;;
    esac
    
    echo -e "${CC_NEON}Powered By root@cavrix.core${CC_RESET}"
}

# ============================================================================
# MAIN MENU
# ============================================================================
main_menu() {
    while true; do
        cavrix_banner
        
        # Quick status
        local total_vms=$(ls "$SCRIPT_DIR"/start-*.sh 2>/dev/null | wc -l)
        local running_vms=$(ps aux | grep -c "[q]emu-system")
        local disk_used=$(du -sh "$CAVRIX_DIR" 2>/dev/null | cut -f1 || echo "0B")
        
        echo -e "${CC_CYAN}System Status:${CC_RESET}"
        echo -e "  ${CC_GREEN}VMs:${CC_RESET} $total_vms total, $running_vms running"
        echo -e "  ${CC_GREEN}Disk:${CC_RESET} $disk_used used"
        echo -e "  ${CC_GREEN}Time:${CC_RESET} $(date '+%H:%M:%S')"
        echo ""
        
        echo -e "${CC_CYAN}Main Menu:${CC_RESET}"
        echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
        echo ""
        echo -e "  ${CC_GREEN}1)${CC_RESET} ${IC_ROCKET} Create New VM"
        echo -e "  ${CC_GREEN}2)${CC_RESET} ${IC_CLOUD} List All VMs"
        echo -e "  ${CC_GREEN}3)${CC_RESET} ${IC_STAR} Start VM"
        echo -e "  ${CC_GREEN}4)${CC_RESET} ${IC_ERR} Stop VM"
        echo -e "  ${CC_GREEN}5)${CC_RESET} ğŸ—‘ï¸  Delete VM"
        echo -e "  ${CC_GREEN}6)${CC_RESET} ${IC_RDP} Setup RDP Server"
        echo -e "  ${CC_GREEN}7)${CC_RESET} ğŸ“Š System Status"
        echo -e "  ${CC_GREEN}8)${CC_RESET} ğŸ§¹ Cleanup"
        echo -e "  ${CC_GREEN}9)${CC_RESET} âš™ï¸  Settings"
        echo -e "  ${CC_RED}0)${CC_RESET} ğŸšª Exit Cavrix Core"
        echo ""
        echo -e "${CC_PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${CC_RESET}"
        echo -e "${CC_NEON}                    Powered By root@cavrix.core                       ${CC_RESET}"
        echo ""
        
        read -rp "$(echo -e "${CC_NEON}Select option (0-9): ${CC_RESET}")" choice
        
        case $choice in
            1) create_vm ;;
            2) list_vms ;;
            3) start_vm ;;
            4) stop_vm ;;
            5) delete_vm ;;
            6) setup_rdp ;;
            7) system_status ;;
            8) cleanup_system ;;
            9) settings_menu ;;
            0)
                cavrix_print "success" "Thank you for using Cavrix Core!"
                echo -e "${CC_NEON}"
                cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                      â•‘
â•‘              Professional Virtualization Platform                    â•‘
â•‘                 Cavrix Core â€¢ Secure â€¢ Reliable                     â•‘
â•‘                    Powered By root@cavrix.core                      â•‘
â•‘                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
                echo -e "${CC_RESET}"
                exit 0
                ;;
            *)
                cavrix_print "error" "Invalid option"
                ;;
        esac
        
        echo ""
        read -rp "$(echo -e "${CC_CYAN}Press Enter to continue...${CC_RESET}")"
    done
}

# ============================================================================
# SETTINGS MENU
# ============================================================================
settings_menu() {
    cavrix_banner
    cavrix_print "header" "SETTINGS"
    
    echo "1) Change VM Directory"
    echo "2) Configure Defaults"
    echo "3) View Logs"
    echo "4) Backup Configuration"
    echo "0) Back"
    
    read -rp "$(echo -e "${CC_NEON}Select option: ${CC_RESET}")" choice
    
    case $choice in
        3)
            echo -e "${CC_CYAN}Recent Logs:${CC_RESET}"
            tail -20 "$LOG_DIR/cavrix.log" 2>/dev/null || echo "No logs available"
            ;;
        0)
            return
            ;;
        *)
            cavrix_print "info" "Feature coming soon"
            ;;
    esac
    
    echo -e "${CC_NEON}Powered By root@cavrix.core${CC_RESET}"
}

# ============================================================================
# MAIN FUNCTION
# ============================================================================
main() {
    # Check dependencies
    check_dependencies
    
    # Display welcome
    cavrix_banner
    cavrix_print "cavrix" "Initializing Cavrix Core Hypervisor..."
    cavrix_print "info" "Version: $CAVRIX_VERSION"
    cavrix_print "info" "Directory: $CAVRIX_DIR"
    cavrix_print "success" "Ready to launch!"
    sleep 2
    
    # Start main menu
    main_menu
}

# ============================================================================
# RUN SCRIPT
# ============================================================================
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
